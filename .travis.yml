language: generic

jobs:
  include:
#    - stage: Cache
#      os: osx
#      env:
#        - VERSION=2.7.15
#          SOURCE=macpython
#          DEPENDENCIES=pip
#      script: true
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#    - stage: Test PyInstaller
#      os: osx
#      env:
#        - VERSION=2.7.15
#          SOURCE=macpython
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/unit tests/functional --ignore=tests/functional/test_libraries.py --ignore=tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#    - stage: Test Libraries
#      os: osx
#      env:
#        - VERSION=2.7.15
#          SOURCE=macpython
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/functional/test_libraries.py tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#
#    - stage: Cache
#      os: osx
#      env:
#        - VERSION=3.4.4
#          SOURCE=macpython
#          DEPENDENCIES=pip
#      script: true
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#    - stage: Test PyInstaller
#      os: osx
#      env:
#        - VERSION=3.4.4
#          SOURCE=macpython
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/unit tests/functional --ignore=tests/functional/test_libraries.py --ignore=tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#    - stage: Test Libraries
#      os: osx
#      env:
#        - VERSION=3.4.4
#          SOURCE=macpython
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/functional/test_libraries.py tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#
#    - stage: Cache
#      os: osx
#      env:
#        - VERSION=3.5.4
#          SOURCE=macpython
#          DEPENDENCIES=pip
#      script: true
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#    - stage: Test PyInstaller
#      os: osx
#      env:
#        - VERSION=3.5.4
#          SOURCE=macpython
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/unit tests/functional --ignore=tests/functional/test_libraries.py --ignore=tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#    - stage: Test Libraries
#      os: osx
#      env:
#        - VERSION=3.5.4
#          SOURCE=macpython
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/functional/test_libraries.py tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#
#    - stage: Cache
#      os: osx
#      env:
#        - VERSION=3.6.6
#          SOURCE=macpython
#          DEPENDENCIES=pip
#      script: true
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#    - stage: Test PyInstaller
#      os: osx
#      env:
#        - VERSION=3.6.6
#          SOURCE=macpython
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/unit tests/functional --ignore=tests/functional/test_libraries.py --ignore=tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#    - stage: Test Libraries
#      os: osx
#      env:
#        - VERSION=3.6.6
#          SOURCE=macpython
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/functional/test_libraries.py tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#
#    - stage: Cache
#      os: osx
#      env:
#        - VERSION=3.7.0
#          SOURCE=macpython
#          DEPENDENCIES=pip
#      script: true
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#    - stage: Test PyInstaller
#      os: osx
#      env:
#        - VERSION=3.7.0
#          SOURCE=macpython
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/unit tests/functional --ignore=tests/functional/test_libraries.py --ignore=tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#    - stage: Test Libraries
#      os: osx
#      env:
#        - VERSION=3.7.0
#          SOURCE=macpython
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/functional/test_libraries.py tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#
#    - stage: Cache
#      os: osx
#      env:
#        - VERSION=2.7
#          SOURCE=macports
#          DEPENDENCIES=pip
#      script: true
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#    - stage: Test PyInstaller
#      os: osx
#      env:
#        - VERSION=2.7
#          SOURCE=macports
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/unit tests/functional --ignore=tests/functional/test_libraries.py --ignore=tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#    - stage: Test Libraries
#      os: osx
#      env:
#        - VERSION=2.7
#          SOURCE=macports
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/functional/test_libraries.py tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#
#    - stage: Cache
#      os: osx
#      env:
#        - VERSION=3.4
#          SOURCE=macports
#          DEPENDENCIES=pip
#      script: true
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#    - stage: Test PyInstaller
#      os: osx
#      env:
#        - VERSION=3.4
#          SOURCE=macports
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/unit tests/functional --ignore=tests/functional/test_libraries.py --ignore=tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#    - stage: Test Libraries
#      os: osx
#      env:
#        - VERSION=3.4
#          SOURCE=macports
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/functional/test_libraries.py tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#
#    - stage: Cache
#      os: osx
#      env:
#        - VERSION=3.5
#          SOURCE=macports
#          DEPENDENCIES=pip
#      script: true
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#    - stage: Test PyInstaller
#      os: osx
#      env:
#        - VERSION=3.5
#          SOURCE=macports
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/unit tests/functional --ignore=tests/functional/test_libraries.py --ignore=tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#    - stage: Test Libraries
#      os: osx
#      env:
#        - VERSION=3.5
#          SOURCE=macports
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/functional/test_libraries.py tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#
#    - stage: Cache
#      os: osx
#      env:
#        - VERSION=3.6
#          SOURCE=macports
#          DEPENDENCIES=pip
#      script: true
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#    - stage: Test PyInstaller
#      os: osx
#      env:
#        - VERSION=3.6
#          SOURCE=macports
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/unit tests/functional --ignore=tests/functional/test_libraries.py --ignore=tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#    - stage: Test Libraries
#      os: osx
#      env:
#        - VERSION=3.6
#          SOURCE=macports
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/functional/test_libraries.py tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#
#    - stage: Cache
#      os: osx
#      env:
#        - VERSION=3.7
#          SOURCE=macports
#          DEPENDENCIES=pip
#      script: true
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#    - stage: Test PyInstaller
#      os: osx
#      env:
#        - VERSION=3.7
#          SOURCE=macports
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/unit tests/functional --ignore=tests/functional/test_libraries.py --ignore=tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#    - stage: Test Libraries
#      os: osx
#      env:
#        - VERSION=3.7
#          SOURCE=macports
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/functional/test_libraries.py tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#
#    - stage: Cache
#      os: osx
#      env:
#        - VERSION=2
#          SOURCE=homebrew
#          DEPENDENCIES=pip
#      script: true
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/Library/Caches/Homebrew
#    - stage: Test PyInstaller
#      os: osx
#      env:
#        - VERSION=2
#          SOURCE=homebrew
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/unit tests/functional --ignore=tests/functional/test_libraries.py --ignore=tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/Library/Caches/Homebrew
#    - stage: Test Libraries
#      os: osx
#      env:
#        - VERSION=2
#          SOURCE=homebrew
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/functional/test_libraries.py tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/Library/Caches/Homebrew
#
#    - stage: Cache
#      os: osx
#      env:
#        - VERSION=3
#          SOURCE=homebrew
#          DEPENDENCIES=pip
#      script: true
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/Library/Caches/Homebrew
#    - stage: Test PyInstaller
#      os: osx
#      env:
#        - VERSION=3
#          SOURCE=homebrew
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/unit tests/functional --ignore=tests/functional/test_libraries.py --ignore=tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/Library/Caches/Homebrew
#    - stage: Test Libraries
#      os: osx
#      env:
#        - VERSION=3
#          SOURCE=homebrew
#          DEPENDENCIES=pip
#      script: py.test -n auto tests/functional/test_libraries.py tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/Library/Caches/Homebrew

    - stage: Cache
      os: osx
      env:
        - VERSION=2.7
          SOURCE=macports
          DEPENDENCIES=macports
      script: true
      cache:
        directories:
          - $HOME/Library/Caches/pip
          - $HOME/macports_cache
#    - stage: Test PyInstaller
#      os: osx
#      env:
#        - VERSION=2.7
#          SOURCE=macports
#          DEPENDENCIES=macports
#      script: py.test -n auto tests/unit tests/functional --ignore=tests/functional/test_libraries.py --ignore=tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#    - stage: Test Libraries
#      os: osx
#      env:
#        - VERSION=2.7
#          SOURCE=macports
#          DEPENDENCIES=macports
#      script: py.test -n auto tests/functional/test_libraries.py tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache

    - stage: Cache
      os: osx
      env:
        - VERSION=3.4
          SOURCE=macports
          DEPENDENCIES=macports
      script: true
      cache:
        directories:
          - $HOME/Library/Caches/pip
          - $HOME/macports_cache
#    - stage: Test PyInstaller
#      os: osx
#      env:
#        - VERSION=3.4
#          SOURCE=macports
#          DEPENDENCIES=macports
#      script: py.test -n auto tests/unit tests/functional --ignore=tests/functional/test_libraries.py --ignore=tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#    - stage: Test Libraries
#      os: osx
#      env:
#        - VERSION=3.4
#          SOURCE=macports
#          DEPENDENCIES=macports
#      script: py.test -n auto tests/functional/test_libraries.py tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache

    - stage: Cache
      os: osx
      env:
        - VERSION=3.5
          SOURCE=macports
          DEPENDENCIES=macports
      script: true
      cache:
        directories:
          - $HOME/Library/Caches/pip
          - $HOME/macports_cache
#    - stage: Test PyInstaller
#      os: osx
#      env:
#        - VERSION=3.5
#          SOURCE=macports
#          DEPENDENCIES=macports
#      script: py.test -n auto tests/unit tests/functional --ignore=tests/functional/test_libraries.py --ignore=tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#    - stage: Test Libraries
#      os: osx
#      env:
#        - VERSION=3.5
#          SOURCE=macports
#          DEPENDENCIES=macports
#      script: py.test -n auto tests/functional/test_libraries.py tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache

    - stage: Cache
      os: osx
      env:
        - VERSION=3.6
          SOURCE=macports
          DEPENDENCIES=macports
      script: true
      cache:
        directories:
          - $HOME/Library/Caches/pip
          - $HOME/macports_cache
#    - stage: Test PyInstaller
#      os: osx
#      env:
#        - VERSION=3.6
#          SOURCE=macports
#          DEPENDENCIES=macports
#      script: py.test -n auto tests/unit tests/functional --ignore=tests/functional/test_libraries.py --ignore=tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#    - stage: Test Libraries
#      os: osx
#      env:
#        - VERSION=3.6
#          SOURCE=macports
#          DEPENDENCIES=macports
#      script: py.test -n auto tests/functional/test_libraries.py tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache

    - stage: Cache
      os: osx
      env:
        - VERSION=3.7
          SOURCE=macports
          DEPENDENCIES=macports
      script: true
      cache:
        directories:
          - $HOME/Library/Caches/pip
          - $HOME/macports_cache
#    - stage: Test PyInstaller
#      os: osx
#      env:
#        - VERSION=3.7
#          SOURCE=macports
#          DEPENDENCIES=macports
#      script: py.test -n auto tests/unit tests/functional --ignore=tests/functional/test_libraries.py --ignore=tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache
#    - stage: Test Libraries
#      os: osx
#      env:
#        - VERSION=3.7
#          SOURCE=macports
#          DEPENDENCIES=macports
#      script: py.test -n auto tests/functional/test_libraries.py tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/macports_cache

    - stage: Cache
      os: osx
      env:
        - VERSION=2
          SOURCE=homebrew
          DEPENDENCIES=homebrew
      script: true
      cache:
        directories:
          - $HOME/Library/Caches/pip
          - $HOME/Library/Caches/Homebrew
#    - stage: Test PyInstaller
#      os: osx
#      env:
#        - VERSION=2
#          SOURCE=homebrew
#          DEPENDENCIES=homebrew
#      script: py.test -n auto tests/unit tests/functional --ignore=tests/functional/test_libraries.py --ignore=tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/Library/Caches/Homebrew
#    - stage: Test Libraries
#      os: osx
#      env:
#        - VERSION=2
#          SOURCE=homebrew
#          DEPENDENCIES=homebrew
#      script: py.test -n auto tests/functional/test_libraries.py tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/Library/Caches/Homebrew

    - stage: Cache
      os: osx
      env:
        - VERSION=3
          SOURCE=homebrew
          DEPENDENCIES=homebrew
      script: true
      cache:
        directories:
          - $HOME/Library/Caches/pip
          - $HOME/Library/Caches/Homebrew
#    - stage: Test PyInstaller
#      os: osx
#      env:
#        - VERSION=3
#          SOURCE=homebrew
#          DEPENDENCIES=homebrew
#      script: py.test -n auto tests/unit tests/functional --ignore=tests/functional/test_libraries.py --ignore=tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/Library/Caches/Homebrew
#    - stage: Test Libraries
#      os: osx
#      env:
#        - VERSION=3
#          SOURCE=homebrew
#          DEPENDENCIES=homebrew
#      script: py.test -n auto tests/functional/test_libraries.py tests/functional/test_hooks
#      cache:
#        directories:
#          - $HOME/Library/Caches/pip
#          - $HOME/Library/Caches/Homebrew

  allow_failures:
    - os: osx
      env:
        - VERSION=2.7
          SOURCE=macports
          DEPENDENCIES=macports
      cache:
        directories:
          - $HOME/Library/Caches/pip
          - $HOME/macports_cache
    - os: osx
      env:
        - VERSION=3.4
          SOURCE=macports
          DEPENDENCIES=macports
      cache:
        directories:
          - $HOME/Library/Caches/pip
          - $HOME/macports_cache
    - os: osx
      env:
        - VERSION=3.5
          SOURCE=macports
          DEPENDENCIES=macports
      cache:
        directories:
          - $HOME/Library/Caches/pip
          - $HOME/macports_cache
    - os: osx
      env:
        - VERSION=3.6
          SOURCE=macports
          DEPENDENCIES=macports
      cache:
        directories:
          - $HOME/Library/Caches/pip
          - $HOME/macports_cache
    - os: osx
      env:
        - VERSION=3.7
          SOURCE=macports
          DEPENDENCIES=macports
      cache:
        directories:
          - $HOME/Library/Caches/pip
          - $HOME/macports_cache
    - os: osx
      env:
        - VERSION=2
          SOURCE=homebrew
          DEPENDENCIES=homebrew
      cache:
        directories:
          - $HOME/Library/Caches/pip
          - $HOME/Library/Caches/Homebrew
    - os: osx
      env:
        - VERSION=3
          SOURCE=homebrew
          DEPENDENCIES=homebrew
      cache:
        directories:
          - $HOME/Library/Caches/pip
          - $HOME/Library/Caches/Homebrew

# Cache pip packages. Explicitly name the pip-cache directory since we
# use a custom `install` step which annuls `cache: pip`.
cache:
  timeout: 500

env:
  global:
    - PYI_COMMIT=green-tests
    - REPO_DIR=pyinstaller


# Install dependencies.
install:
  # Build Python interpreter
  - source terryfy/travis_tools.sh
  - cd terryfy; git submodule update --remote multibuild/; cd ..
  - source terryfy/multibuild/osx_utils.sh
  - source $TRAVIS_BUILD_DIR/utils_travis.sh
  - if [ $SOURCE = homebrew ]; then brew uninstall geos gdal postgis; fi
  - get_python_environment $SOURCE $VERSION venv
  - register_cache
  - if [ $SOURCE = macports ]; then sudo port -pb install curl | cat; fi
  - ${PIP_CMD} install --progress-bar=off travispls
  - source terryfy/test_python_installs.sh
  - if [ $SOURCE = macports ]; then export PYTHON_VERSION=`get_py_mm_nodot`; else export PYTHON_VERSION=`get_py_digit`; fi

  # Checkout latest PyInstaller.
  - cd $TRAVIS_BUILD_DIR
  - checkout_commit $REPO_DIR $PYI_COMMIT | cat

  # Compile bootloader.
  - cd $TRAVIS_BUILD_DIR/$REPO_DIR/bootloader
  - $PYTHON_EXE waf distclean all

  # Install PyInstaller.
  - cd $TRAVIS_BUILD_DIR/$REPO_DIR
  - $PIP_CMD install --progress-bar=off -e .

  # Install dependencies for tests.
  # Download-progress bars break Travis's log view. Disable them by piping output
  # through another program (if output is not a tty, no progress bars)
  - ${PIP_CMD} install --progress-bar=off -U pip
  - ${PIP_CMD} install --progress-bar=off -r $TRAVIS_BUILD_DIR/$REPO_DIR/tests/requirements-tools.txt
  - install_dependencies
  # Make sure virtualenv is activated.
  - source $TRAVIS_BUILD_DIR/venv/bin/activate
  - cd $TRAVIS_BUILD_DIR/$REPO_DIR

script:
  # Run tests and speed them up by sending them to multiple CPUs.
  - py.test -n auto
before_cache:
  - prep_cache
